<html>
	<head>
		<link rel="stylesheet" href="style.css"/>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	</head>
<body>
	<div id="lives"></div>
	<div id="playspace">
		<canvas id="playarea" style="width:500px; height:500px;"></canvas>
	</div>
<script type="text/javascript">
/*
todo:
Inertia turning
+ much much more
*/
"use strict";
//(function(){//Anon

function bullet(position, orientation, reference) {
	this.reference = reference;
	this.position = position;
	this.orientation = orientation;
	this.velocity = 20;
	this.object = new this.object(this.position, this.orientation);
}

bullet.prototype.remove = function () {//if bullet has hit something or hit the side of the screen destroy it
	try {
		document.getElementById('playspace').removeChild(this.object.element);//randomly erroring
	} catch (err) {
		console.log('failed to remove bullet: ' + err);
	}
};

bullet.prototype.object = function (position, orientation) {
	this.element = document.createElement('canvas');//Create new Canvas
	this.element.id = "bullet" + (new Date()).getTime();
	this.element.style.position = "fixed";
	this.element.style.top = position[1];
	this.element.style.left = position[0];
	document.getElementById('playspace').appendChild(this.element);
	this.canvas = this.element.getContext('2d');
	this.element.setAttribute('width', '5');
	this.element.setAttribute('height', '10');
	this.points = [[3, 0], [3, 10]];
	this.canvas.beginPath();
	this.canvas.moveTo(this.points[0][0], this.points[0][1]);
	this.canvas.lineTo(this.points[1][0], this.points[1][1]);  //Draw to canvas
	this.canvas.closePath();
	this.canvas.stroke();
	this.element.style.webkitTransform = "rotate(" + orientation + "deg)";
};

bullet.prototype.move = function () {//Moving bullet forward
	this.directions = [];
	var radians = this.orientation * (Math.PI/180);
	this.directions[0] = Math.sin(radians);
	this.directions[1] = Math.cos(radians);
	this.position[0] = this.position[0] +  this.velocity * this.directions[0];
	this.position[1] = this.position[1] - this.velocity * this.directions[1];
	this.object.element.style.left = this.position[0];//Horizontal
	this.object.element.style.top = this.position[1];//Vertical
	if (this.position[0] < -55 || this.position[1] < -55 || this.position[0] > gameWidth || this.position[1] > gameHeight) {
		this.remove();
		return true;
	} //Remove when hit edge
	return false;
};

bullet.prototype.checkCollision = function () {
	for (var i=0; i < asteroids.length; i++) {
		if (
			this.position[0] < asteroids[i].position[0] + asteroids[i].object.element.width/2 && 
			this.position[0] >  asteroids[i].position[0] - asteroids[i].object.element.width/2 && 
			this.position[1] < asteroids[i].position[1] + asteroids[i].object.element.height/2 && 
			this.position[1] >  asteroids[i].position[1] -asteroids[i].object.element.height/2
		) {
			//console.log('Asteroid hit with bullet: ' +  this.object.element.id);
			asteroids[i].explode();
			try {
				this.remove();
			} catch (err) {
				alert("Cannot delete el" + this.object.element + "err:" + err);
			}
			asteroids.splice(i, 1);
			return true;
		}
	}
	return false;
};

function player() {
	this.velocity = 0;
	this.direction = [];
	this.orientation = 0;
	this.position = [];
	this.position[0] = gameWidth / 2;
	this.position[1] = gameHeight / 2;
	this.object = new this.object(this.position);
}

player.prototype.validateCollision = function (id) {//check if the player last hit the same asteroid
	//if (this.lastasteroid !== window.undefinded  || this.lastasteroid !== id) {//same asteroid
	//}
	this.lastasteroid = id;
};

player.prototype.decreaseLives = function () {
	if(scoring.decrease() < 1){
		this.die();
	}
};

player.prototype.increaseLives = function () {
	this.lives++;
};

player.prototype.fire = function () {//create new bullet
	//Find the front point for the player
	//this.directions[0] = Math.sin(this.direction / 57.3);
	//this.directions[1] = Math.cos(this.direction / 57.3);
	//I wonder if 57.3 is the holy number - Better to try
	var radians = this.direction * (Math.PI/180);
	this.directions[0] = 15 * Math.sin(radians);
	this.directions[1] = 15 * Math.cos(radians);
	//console.log('New bullets' + this.directions[0] + ';' + this.directions[1]);
/*
//Side weapons
	bullets.push(
		new bullet(
			[
				this.position[0] + 15 - 3 + (this.directions[1]),//Width of bullet 6px 
				this.position[1] + 15 - 3 + (this.directions[0])//width of ship 30px
			], 
			this.orientation, 
			this
		)
	);
	bullets.push(
		new bullet(
			[
				this.position[0] + 15 - 3 - (this.directions[1]),//Width of bullet 6px 
				this.position[1] + 15 - 3 - (this.directions[0])//width of ship 30px
			], 
			this.orientation, 
			this
		)
	);
*/
	this.directions[0] = Math.sin(radians);
	this.directions[1] = Math.cos(radians);

	
		bullets.push(
		new bullet(
			[
				this.position[0] + 12 +  15 * this.directions[0],
				this.position[1] + 12 - 15 * this.directions[1]//Width of bullet 6px 
			], 
			this.orientation, 
			this
		)
	);
};

player.prototype.object = function (position) {
	this.element = document.createElement('canvas');//Create new Canvas
	this.element.id = "player";
	this.element.style.position = "fixed";
	this.element.style.top = position[1];
	this.element.style.left = position[0];
	document.getElementById('playspace').appendChild(this.element);
	this.canvas = this.element.getContext('2d');
	this.element.setAttribute('width', '30');
	this.element.setAttribute('height', '30');
	this.points = [[0, 30], [15, 0], [30, 30], [15, 20]];
	this.canvas.beginPath();
	this.canvas.moveTo(this.points[0][0], this.points[0][1]);
	var i = 1;
	while (i < this.points.length) {
		this.canvas.lineTo(this.points[i][0], this.points[i][1]);//Draw to canvas
		i++;
	}
	this.canvas.closePath();
	this.canvas.stroke();
};

player.prototype.turn = function (direction) {

	if (direction === "clockwise") {
		if (this.orientation >= 360) {
			this.orientation = 0;
		}
		this.orientation = this.orientation + 5;
	} else {
		if (this.orientation <= 0) {
			this.orientation = 360;
		}
		this.orientation = this.orientation - 5;
	}

	this.object.element.style.webkitTransform = "rotate(" + this.orientation + "deg)";
};

player.prototype.forward = function () {
	if (this.velocity < 30) {
		this.velocity += 2;
	}
};

player.prototype.back = function () {
	if (this.velocity > -20) {//Lower limit
		this.velocity -= 2;
	}
};

player.prototype.move = function () {//Moving player forward
	if (this.orientation === 360) {
		this.orientation = 0;
	}
	this.directions = [];
	this.direction = this.orientation;
	this.directions[0] = Math.sin(this.direction / 57.3);
	this.directions[1] = Math.cos(this.direction / 57.3);
	if (this.position[0] < -55) {
		this.position[0] = gameWidth - 10;
	} //Loop rounds Game screen
	if (this.position[1] < -55) {
		this.position[1] = gameHeight - 10;
	}
	if (this.position[0] > gameWidth) {
		this.position[0] = -30;
	}
	if (this.position[1] > gameHeight) {
		this.position[1] = -30;
	}
	this.position[0]  += (this.velocity * (this.directions[0]));
	this.position[1] -= (this.velocity * (this.directions[1]));
	this.object.element.style.left = this.position[0];//Horizontal
	this.object.element.style.top = this.position[1];//Vertical
	if (this.velocity > 0) {
		this.velocity -= 0.6;
	}//Decrement velocity - Slow down
	if (this.velocity < 0) {
		this.velocity += 0.6;
	}//if going backwards also slow down
};

player.prototype.die = function () {
	//player has been killed
	console.log('player dead');
	window.clearInterval(gameLoop);
};

function asteroid(speed, weight, rotationspeed, position) {//main asteroid object
	this.speed = speed;
	this.weight = weight;
	this.orientation = Math.random() * 360;
	this.direction = [];
	this.direction[0] = (Math.random() * 7) * (Math.random() * 3 - 1);
	this.direction[1] = (Math.random() * 7) * (Math.random() * 3 - 1);
	this.rotationspeed = rotationspeed;
	this.position = position;
	this.object = new this.object(this.position, weight);
}

asteroid.prototype.rotate = function () {
	this.orientation = this.orientation  +  this.rotationspeed;
	this.object.element.style.webkitTransform = "rotate(" + (this.orientation + this.rotationspeed) + "deg)";
};

asteroid.prototype.move = function () {
	this.position[0] = this.position[0] + (this.speed * this.direction[0]);//Horizontal
	this.position[1] = this.position[1] + (this.speed * this.direction[1]);//Vertical
	if (this.position[0] < -55) {
		this.position[0] = gameWidth - 10;
	}//Horizontal
	if (this.position[1] < -55) {
		this.position[1] = gameHeight - 10;
	}//Vertical
	if (this.position[0] > gameWidth) {
		this.position[0] = -50;
	}//Horizontal
	if (this.position[1] > gameHeight) {
		this.position[1] = -50;
	}//Vertical
	this.object.element.style.left = this.position[0];//Horizontal
	this.object.element.style.top = this.position[1];//Vertical
};

asteroid.prototype.remove = function () {
	//console.log('remove asteroid ' + this.object.element.id);
	try {
		document.getElementById('playspace').removeChild(this.object.element);//randomly erroring
	} catch (err) {
		console.log('failed to remove bullet: ' + err);
	}
}

asteroid.prototype.explode = function () {
	/*
	Use the objects properties to create new objects
	Add the objects to the asteroids array
	need to be smaller / moving in same direction
	Use the weight property to modify the asteroids smaller
	Divide by 4?
	When at 1 - destroy 
	*/
	this.remove();//Remove first
	var newamount = (this.weight / 5);
	var i = 0;
	if(newamount > 1){
		while (i < newamount) {
			asteroids.push(
				new asteroid(
					parseInt((Math.random() + 0.4) * 2), 
					newamount * 2, 
					(Math.random() + 0.3 * 40), 
					[this.position[0], this.position[1]]
				)
			);//Speed / Weight / RotationSpeed / Position
			//console.log('Create Asteroid ' + (i+1) + " of " + newamount);
			i++;
		}
	}
};

asteroid.prototype.object = function (position, weight) {
	this.element = document.createElement('canvas');//Create new Canvas
	this.element.id = "asteroid" + Math.random();
	this.element.style.position = "fixed";
	this.element.style.top = position[0];
	this.element.style.left = position[1];
	document.getElementById('playspace').appendChild(this.element);
	this.canvas = this.element.getContext('2d');
	this.points = [[25, 5], [38, 10], [45, 25], [41, 37], [25,45], [10,39], [5,25], [11, 10]];
	var i = 0;
	while (i < this.points.length) {
		this.points[i][0] = this.points[i][0] * (weight / 10); 
		this.points[i][1] = this.points[i][1] * (weight / 10); 
		i++;
	}
	
	var i = 0;
	while (i < this.points.length) {
		if (Math.random() >= 0.5) {
			this.points[i][0] = parseInt(this.points[i][0]  +  Math.random() * (Math.random() * 8));
		} else {
			this.points[i][0] = parseInt(this.points[i][0] - Math.random() * (Math.random() * 8));
		}
		if (Math.random() >= 0.5) {
			this.points[i][1] = parseInt(this.points[i][1]  +  Math.random() * (Math.random() * 8));
		} else {
			this.points[i][1] = parseInt(this.points[i][1] - Math.random() * (Math.random() * 8));
		}
		i++;
	}
	//Move asteroid to top left of canvas - crop to size
	i = 0;
	this.smallX = 50;
	this.largeX = 0;
	this.smallY = 50;
	this.largeY = 0;
	while (i < this.points.length) {
		if (this.points[i][0] < this.smallX) {
			this.smallX = this.points[i][0];
		}
		if (this.points[i][0] > this.largeX) {
			this.largeX = this.points[i][0];
		}
		if (this.points[i][1] < this.smallY) {
			this.smallY = this.points[i][1];
		}
		if (this.points[i][1] > this.largeY) {
			this.largeY = this.points[i][1];
		}
		i++;
	}
	i = 0;
	while (i < this.points.length) {	//offset asteroid
		this.points[i][0] -= this.smallX;
		this.points[i][1] -= this.smallY;
		i++;
	}
	this.element.setAttribute('width', this.largeX + 1 - this.smallX + "px");
	this.element.setAttribute('height', this.largeY + 1 - this.smallY + "px");
	this.canvas.beginPath();
	this.canvas.moveTo(this.points[0][0], this.points[0][1]);
	i = 0;
	while (i < this.points.length) {
		this.canvas.lineTo(this.points[i][0], this.points[i][1]);
		i++;
	}
	this.canvas.closePath();
	this.canvas.stroke();//Draw to canvas
};

asteroid.prototype.checkCollision = function () {
	if (
		this.position[0] < player.position[0] + this.object.element.width && 
		this.position[0] >  player.position[0] - this.object.element.width && 
		this.position[1] < player.position[1] + this.object.element.height && 
		this.position[1] >  player.position[1] - this.object.element.height
	) {
		//player.validateCollision();
		console.log('Hit with ' +  this.object.element.id);//replace with player health decrement
		this.remove();
		player.decreaseLives();
		return true;
	}
	return false;
};

function createLevelAsteroids(value) {
	asteroids = [];
	var ii = 0;
	while (ii < value) {
		asteroids[ii] = new asteroid(parseInt((Math.random() + 0.3) * 2), (5+10*Math.random()), (Math.random() + 0.3 * 40), [gameWidth * Math.random(), gameHeight * Math.random()]);//Speed / Weight / RotationSpeed / Position
		ii++;
	}
}

function windowResize() {
	gameHeight = window.innerHeight;
	gameWidth = window.innerWidth;
}

function loop() {
	for (var i in asteroids) {asteroids[i].rotate(); }//Rotate asteroids
	for (var i in asteroids) {asteroids[i].move(); }//Move asteroids in right direction
	//for (var i in asteroids) {asteroids[i].checkCollision(); }//Check for hits
	for (var i in bullets) {
		if (bullets[i].move()) { 
			bullets.splice(i, 1);
		}
	}//Move bullets
	for (var i=0; i < bullets.length; i++) {
		if (bullets[i].checkCollision()) {
			bullets.splice(i, 1);//Delete bullet
		}
	}//Check for hits
	
	for (var i=0; i < asteroids.length; i++) {
		if (asteroids[i].checkCollision()) {
			asteroids.splice(i, 1);//Delete bullet
		}
	}//Check for hits
	player.move();
	//player.hitTest();
}

function toPositive(value) {
	if (value < 0) {
		value = - value;
	}
	return value;
}

document.onkeydown = function (ev) {//Used to register key presses - no onkeyup - multipress?
	switch(ev.keyCode) {
		case 37://left
			if (!leftloop) {
				player.turn('anticlockwise');
				leftloop = window.setInterval(function(){player.turn('anticlockwise')}, 30);
			}
			break;
		case 38://Up
			if (!forwards) {
				player.forward();
				forwards = window.setInterval(function(){player.forward()}, 50);
			}
			//player.forward();
			break
		case 39://right
			if (!rightloop) {
				player.turn('clockwise');
				rightloop = window.setInterval(function(){player.turn('clockwise')}, 30);
			}
			//player.turn('clockwise');
			break;
		case 40://Down
			if (!backwards) {
				player.back();
				backwards = window.setInterval(function(){player.back()}, 50);
			}
			break;
		case 32://Spacebar
			if (!fireloop) {
				player.fire();//First firing
				fireloop = window.setInterval(function(){player.fire()}, 150);
			}
			break;
	}
}

document.onkeyup = function (ev) {//Used to register key presses - no onkeyup = multipress?
	switch(ev.keyCode) {//console.log('press' + ev.keyCode);
		case 37://left
			window.clearInterval(leftloop);
			leftloop = null;
			//player.turn('anticlockwise');
			break;
		case 38://Up
			window.clearInterval(forwards);
			forwards = null;
			//player.forward();
			break;
		case 39://right
			window.clearInterval(rightloop);
			rightloop = null;
			//player.turn('clockwise');
			break;
		case 40://Down
			window.clearInterval(backwards);
			backwards = null;
			//player.back();
			break;
		case 32://Spacebar
			window.clearInterval(fireloop);
			fireloop = null;
			break;
	}
}

var gameLoop = window.setInterval(function(){loop();}, 50);
/* var draw = document.getElementById('playarea').getContext('2d'); */
var gameHeight = window.innerHeight;
var gameWidth = window.innerWidth;
var bullets = [], asteroids = [];
var leftloop, forwards, rightloop, backwards,fireloop;
createLevelAsteroids(10);
var player = new player();
window.onresize = windowResize;	

//})();
</script>

<script type="text/javascript">
scoring = new function() {
	//Attach to holder element
	//Draw the required number of elements
	var element = $("#lives");//Animation Interval
	var lives = 3;	
	this.decrease = function() {
		element.children().last().remove();
		lives = lives - 1;
		return lives;
	}
	this.increase = function() {
		if (isPlaying) {
			isPlaying = false;
			_stop();
		} else {
			isPlaying = true;
			_play();
		}			
	}
	_initialise = function(){
		//Create the 3 elements
		for (var i=0; i < lives; i++) {
			_createElement();
		}
	}
	
	var _createElement = function(){
		element.append("<div class='life'>&nbsp;</div>");
	}
	
	var _play = function() {
		//$("#message").text("");
		var speed = 50;//Number of MiliSeconds on each light
		loop = window.setInterval(function() {
			animate();
		},speed);//Self calling - could use interval instead
		animate(speed);
	}
	
	var animate = function() {
		elements.removeClass("lit");
		index = index >= elements.length ? 0 : index;//Reset index
		elements.eq(index).addClass("lit");
		index++;
	}
	
	var _stop = function() {
		var spins, msg;
		window.clearInterval(loop);//Stop interval
		spins = index === 8 ? 5 : 0; // 0 || 5 extra spins
		if(spins) {
			msg = "Nice one, 5 extra spins";
		} else {
			msg = "Oops. No extra spins";
		}
		GAME.message.queue(msg, 2000,{stopped:true});//5 Seconds
		if(score){
			GAME.credits.add(spins);
		}
		window.setTimeout(function() {
			$("#lights li").removeClass("lit");//Turn off all lights
		}, 2000);
		$("#playbutton").removeClass("playing");
		GAME.switchGames();
	}
	_initialise();
}
</script>
</body>
</html>